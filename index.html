<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calendario académico 2025-2026</title>
<script src="jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="index.css">
</head>
<body>

<h1>Calendario académico 2025-2026 v1.3</h1>

<!-- Resumen de días por persona -->
<h2>Resumen por persona</h2>
<div id="resumen"></div>

<!-- Contenedor del calendario -->
<div id="calendario" class="calendario"></div>

<script>
let dias = {};        // días festivos
let usuarios = [];    // usuarios/personas
let asignaciones = {}; // asignaciones por fecha

// Rango del curso (puede venir de un JSON externo)
const rango = {
  inicio: "2025-09-01",
  fin: "2026-08-31"
};

// Nombres de los meses
const mesesNombres = [
  "Enero","Febrero","Marzo","Abril","Mayo","Junio",
  "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
];

// Carga los datos de días festivos y usuarios
$.when(
  $.getJSON("holidays.json", function(data) { dias = data; }),
  $.getJSON("users.json", function(data) { usuarios = data.usuarios; })
).done(function() {
  generarCalendarioRango(rango.inicio, rango.fin);
});

// =====================
// Función principal para generar calendario dentro de un rango
// =====================
function generarCalendarioRango(fechaInicioStr, fechaFinStr) {
  const fechaInicio = new Date(fechaInicioStr);
  const fechaFin = new Date(fechaFinStr);
  const $contenedor = $("#calendario");
  $contenedor.empty();

  let y = fechaInicio.getFullYear();
  let m = fechaInicio.getMonth();

  // Recorre mes por mes hasta llegar al mes final
  while (y < fechaFin.getFullYear() || (y === fechaFin.getFullYear() && m <= fechaFin.getMonth())) {
    const primerDia = new Date(y, m, 1);
    const ultimoDia = new Date(y, m + 1, 0);
    const nombreMes = mesesNombres[m] + " " + y;

    let html = `<div class="mes"><h2>${nombreMes}</h2><table><thead><tr>
      <th>Lu</th><th>Ma</th><th>Mi</th><th>Ju</th><th>Vi</th><th>Sá</th><th>Do</th>
      </tr></thead><tbody><tr>`;

    // Ajusta inicio de semana (lunes = 0)
    let diaSemana = (primerDia.getDay() + 6) % 7;
    for (let i = 0; i < diaSemana; i++) html += "<td></td>";

    for (let d = 1; d <= ultimoDia.getDate(); d++) {
      const fecha = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
      const fechaObj = new Date(fecha);

      // Solo pinta si está dentro del rango
      if (fechaObj < fechaInicio || fechaObj > fechaFin) continue;

      const festivo = dias[fecha] && (dias[fecha].festivo_estatal || dias[fecha].festivo_local);

      html += `<td class="${festivo ? 'festivo' : ''}" data-fecha="${fecha}">
                  <div>${d}</div>
                  <div class="asignados"></div>
                  <button class="add-btn">+</button>
                  <select multiple class="multiselect">
                    ${usuarios.map(u => `<option value="${u.nombre}">${u.nombre}</option>`).join('')}
                  </select>
               </td>`;

      diaSemana++;
      if (diaSemana === 7 && d < ultimoDia.getDate()) {
        html += "</tr><tr>";
        diaSemana = 0;
      }
    }

    // Rellenar celdas vacías al final de la semana
    while (diaSemana < 7 && diaSemana !== 0) {
      html += "<td></td>";
      diaSemana++;
    }

    html += "</tr></tbody></table></div>";
    $contenedor.append(html);

    // Avanza al siguiente mes
    m++;
    if (m > 11) { m = 0; y++; }
  }

  // =====================
  // Eventos para botones y select múltiple
  // =====================
  $(".add-btn").on("click", function(e) {
    e.stopPropagation();
    const $td = $(this).closest("td");
    const $select = $td.find(".multiselect");
    $(".multiselect").not($select).hide();
    $select.toggle();
  });

  $(".multiselect").on("change", function() {
    const $td = $(this).closest("td");
    const fecha = $td.data("fecha");
    const seleccionados = $(this).val() || [];
    asignaciones[fecha] = seleccionados;
    actualizarDia($td, seleccionados);
  });

  $(document).on("click", function() {
    $(".multiselect").hide();
  });
}

// =====================
// Actualiza el contenido de un día
// =====================
function actualizarDia($td, seleccionados) {
  const $contenedor = $td.find(".asignados");
  $contenedor.empty();
  seleccionados.forEach(nombre => {
    const u = usuarios.find(x => x.nombre === nombre);
    if (u) {
      $contenedor.append(`<span class="inicial" style="background:${u.color}">${u.inicial}</span>`);
    }
  });

  actualizarResumen();
}

// =====================
// Actualiza el resumen por persona
// =====================
function actualizarResumen() {
  const resumen = {};

  for (const fecha in asignaciones) {
    const seleccionados = asignaciones[fecha];
    seleccionados.forEach(nombre => {
      if (!resumen[nombre]) resumen[nombre] = 0;
      resumen[nombre]++;
    });
  }

  const html = Object.entries(resumen)
    .map(([nombre, dias]) => {
      const u = usuarios.find(x => x.nombre === nombre);
      const color = u ? u.color : "#fff";
      return `<div style="display:inline-block; margin:4px; padding:4px; background:${color}; color:#000; border-radius:4px;">
                ${nombre}: ${dias} día${dias > 1 ? 's' : ''}
              </div>`;
    }).join('');

  $("#resumen").html(html);
}

  // ====== Guardar asignaciones a JSON ======
$("#guardar").on("click", function() {
  const dataStr = JSON.stringify(asignaciones, null, 2);
  const blob = new Blob([dataStr], {type: "application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "asignaciones.json";
  a.click();
  URL.revokeObjectURL(url);
});

// ====== Importar JSON de asignaciones ======
$("#importar").on("click", function() {
  $("#importarFile").click();
});

$("#importarFile").on("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = JSON.parse(evt.target.result);
      asignaciones = data;

      // Actualiza la vista del calendario
      $(".mes td").each(function() {
        const fecha = $(this).data("fecha");
        if (fecha && asignaciones[fecha]) {
          actualizarDia($(this), asignaciones[fecha]);
        } else {
          actualizarDia($(this), []);
        }
      });
    } catch(err) {
      alert("Archivo JSON inválido");
      console.error(err);
    }
  };
  reader.readAsText(file);
});
</script>

  <!-- Botones Guardar / Importar -->
<div style="margin:10px 0;">
  <button id="guardar">Guardar</button>
  <input type="file" id="importarFile" style="display:none;">
  <button id="importar">Importar</button>
</div>
</body>
</html>




